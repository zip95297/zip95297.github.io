#!/bin/bash
# ç»™ markdown æ–‡ä»¶äº¤äº’å¼æ·»åŠ  Front-matter å±æ€§

Usage() {
    echo "Usage: $0 <markdown file> [ created date ]"
    echo "This script interactively adds attributes to a markdown file."
    exit 1
}

if [[ $# -lt 1 ]]; then
    Usage
fi

if [[ $# -eq 2 ]]; then
    created_date="$2"
fi

# è·å–ç°æœ‰çš„ tags å’Œ categories å­˜åœ¨äºæ–‡ä»¶ ./value/tags å’Œ ./value/categories ä¸­ è¿”å›ä¸€ä¸ªlist
get_info(){
    local index=$1 # tags or categories
    local file="/Users/zip95297/Repository/BLOG/zjb-blog/utils/value/$index"
    local list=()
    while IFS= read -r line; do
        list+=("$line")
    done < "$file"
    echo "${list[@]}"
}

# å†™å…¥ tags å’Œ categories åˆ°æ–‡ä»¶ ./value/tags å’Œ ./value/categories ä¸­
write_info(){
    local index=$1 # tags or categories
    local value=$2
    local file="/Users/zip95297/Repository/BLOG/zjb-blog/utils/value/$index"
    # åˆ¤æ–­æ˜¯å¦å·²ç»å­˜åœ¨
    if grep -q "$value" "$file"; then
        return
    fi
    echo "$value" >> "$file"
}

# å±æ€§åˆ—è¡¨
attr_options=( "title" "date" "updated" "mathjax" "tags" "categories" "keywords" "cover" "description" "comments" "top_img" "password" "message")

# å‚æ•°æ£€æŸ¥
[[ ! -f $1 ]] && echo "ERROR: File not found." && exit 1
[[ "${1##*.}" != "md" ]] && echo "ERROR: Must be a .md file." && exit 1

file="$1"
filename=$(basename "$file" .md)

# è¯»å–æ–‡ä»¶æ‰€æœ‰è¡Œï¼ˆå…¼å®¹ Bash 3.2ï¼‰
lines=()
while IFS= read -r line; do
    lines+=("$line")
done < "$file"

# æ£€æŸ¥æ˜¯å¦å·²æœ‰ front-matter
has_frontmatter=false
start_line=0
end_line=0
if [[ "${lines[0]}" == "---" ]]; then
    has_frontmatter=true
    for i in "${!lines[@]}"; do
        if [[ $i -gt 0 && "${lines[$i]}" == "---" ]]; then
            end_line=$i
            break
        fi
    done
fi

# æå–å·²æœ‰å±æ€§
existing_attrs=()
if $has_frontmatter; then
    echo "ğŸ“Œ æ£€æµ‹åˆ°å·²æœ‰ Front-matterï¼Œå·²å­˜åœ¨çš„å±æ€§æœ‰ï¼š"
    for ((i=start_line+1; i<end_line; i++)); do
        line="${lines[$i]}"
        key=$(echo "$line" | cut -d: -f1 | xargs)
        val=$(echo "$line" | cut -d: -f2- | xargs)
        existing_attrs+=("$key")
        printf " - %-12s: %s\n" "$key" "$val"
    done
fi


# å‡½æ•°ï¼šåˆ¤æ–­å±æ€§æ˜¯å¦å·²å­˜åœ¨
has_attr() {
    local target="$1"
    for item in "${existing_attrs[@]}"; do
        [[ "$item" == "$target" ]] && return 0
    done
    return 1
}

# åˆ›å»º front-matterï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
if ! $has_frontmatter; then
    echo "âœ… æ–‡ä»¶æ²¡æœ‰ front-matterï¼Œè‡ªåŠ¨æ·»åŠ ï¼"
    {
        echo "---"
        echo "title: \"$filename\""
        # echo "date: $(date '+%Y-%m-%d %H:%M:%S')"
        if [[ -n $created_date ]]; then
            echo "date: $created_date"
        else
            echo "date: $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        echo "updated: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "---"
        cat "$file"
    } > "${file}.tmp" && mv "${file}.tmp" "$file"
    echo "âœ… å·²æ·»åŠ åŸºç¡€ front-matterã€‚"
    exit 0
fi

# é€ä¸€è¯¢é—®ç¼ºå¤±å±æ€§
tmpfile="${file}.tmp"
head -n "$end_line" "$file" > "$tmpfile"

for attr in "${attr_options[@]}"; do
    if has_attr "$attr"; then
        continue
    fi
    if [[ "$attr" == "message" ]]; then
        echo "message å±æ€§æ˜¯å¯†ç æç¤º"
    fi
    echo -n "æ˜¯å¦æ·»åŠ å±æ€§ '$attr'? (y/n): "
    read ans
    if [[ "$ans" == "y" || "$ans" == "Y" ]]; then
        if [[ "$attr" == "title" ]]; then
            value="$filename"
        elif [[ "$attr" == "date" || "$attr" == "updated" ]]; then
            value=$(date '+%Y-%m-%d %H:%M:%S')
        elif [[ "$attr" == "comments" ]]; then
            value=true
        elif [[ "$attr" == "mathjax" ]]; then
            value=true
        elif [[ "$attr" == "tags" ]]; then
            echo -n "è¯·è¾“å…¥ '$attr' çš„å€¼ï¼šå¯ä»¥å¤šä¸ª ç”¨ç©ºæ ¼åˆ†éš”ï¼š"
            get_info "tags"
            echo "å¯é€‰çš„ tags æœ‰ï¼š"
            for tag in $(get_info "tags"); do
                echo "	- $tag"
            done
            echo -n "è¯·è¾“å…¥ tags çš„å€¼ï¼ˆå¤šä¸ªç”¨ç©ºæ ¼åˆ†éš”ï¼‰ï¼š"
            read value
            # æŒ‰ç©ºæ ¼åˆ†éš” ç”¨äºå†™å› è½¬æ¢æˆæ•°ç»„ é€ä¸ªå†™
            valueList=($value)
            for tag in ${valueList[@]}; do
                write_info "tags" "$tag"
            done
            # è½¬æ¢æˆ - value \n - value 1ä¸ªç©ºæ ¼åšåˆ†éš”
            value=$(echo " $value blog" | sed 's/ /\n    - /g' | sed '$d')
        elif [[ "$attr" == "categories" ]]; then
            get_info "categories"
            echo "å·²ç»å­˜åœ¨çš„ categories æœ‰ï¼š"
            for category in $(get_info "categories"); do
                echo "	- $category"
            done
            echo -n "è¯·è¾“å…¥ '$attr' çš„å€¼ï¼š"
            read value
            write_info "categories" "$value"
        elif [[ "$attr" == "password" ]]; then
            echo -n "è¯·è¾“å…¥æ–‡ç« å¯†ç  '$attr' çš„å€¼ï¼šè¾“å…¥ d å°±ç”¨ç”Ÿæ—¥"            
            read value
            if [[ "$value" == "d" ]]; then
                value="20020820"
            fi
        else
            echo -n "è¯·è¾“å…¥ '$attr' çš„å€¼ï¼š"
            read value
        fi
        echo "$attr: $value" >> "$tmpfile"
    fi
done

# echo "---" >> "$tmpfile"
tail -n +"$((end_line+1))" "$file" >> "$tmpfile"
mv "$tmpfile" "$file"

echo "âœ… å±æ€§è¡¥å……å®Œæˆï¼š$file"
echo "----------------------------------------"

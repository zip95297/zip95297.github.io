#!/bin/bash
# ç»™ markdown æ–‡ä»¶äº¤äº’å¼æ·»åŠ  Front-matter å±æ€§

Usage() {
    echo "Usage: $0 <markdown file> [ created date ]"
    echo "This script interactively adds attributes to a markdown file."
    exit 1
}

if [[ $# -eq 2 ]]; then
    created_date="$2"
fi

# å±æ€§åˆ—è¡¨
attr_options=( "title" "date" "updated" "math" "tags" "categories" "keywords" "cover" "description" "comments" "top_img" )

# å‚æ•°æ£€æŸ¥
[[ ! -f $1 ]] && echo "Error: File not found." && exit 1
[[ "${1##*.}" != "md" ]] && echo "Error: Must be a .md file." && exit 1

file="$1"
filename=$(basename "$file" .md)

# è¯»å–æ–‡ä»¶æ‰€æœ‰è¡Œï¼ˆå…¼å®¹ Bash 3.2ï¼‰
lines=()
while IFS= read -r line; do
    lines+=("$line")
done < "$file"

# æ£€æŸ¥æ˜¯å¦å·²æœ‰ front-matter
has_frontmatter=false
start_line=0
end_line=0
if [[ "${lines[0]}" == "---" ]]; then
    has_frontmatter=true
    for i in "${!lines[@]}"; do
        if [[ $i -gt 0 && "${lines[$i]}" == "---" ]]; then
            end_line=$i
            break
        fi
    done
fi

# æå–å·²æœ‰å±æ€§
existing_attrs=()
if $has_frontmatter; then
    echo "ğŸ“Œ æ£€æµ‹åˆ°å·²æœ‰ Front-matterï¼Œå·²å­˜åœ¨çš„å±æ€§æœ‰ï¼š"
    for ((i=start_line+1; i<end_line; i++)); do
        line="${lines[$i]}"
        key=$(echo "$line" | cut -d: -f1 | xargs)
        val=$(echo "$line" | cut -d: -f2- | xargs)
        existing_attrs+=("$key")
        printf " - %-12s: %s\n" "$key" "$val"
    done
fi


# å‡½æ•°ï¼šåˆ¤æ–­å±æ€§æ˜¯å¦å·²å­˜åœ¨
has_attr() {
    local target="$1"
    for item in "${existing_attrs[@]}"; do
        [[ "$item" == "$target" ]] && return 0
    done
    return 1
}

# åˆ›å»º front-matterï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
if ! $has_frontmatter; then
    echo "âš ï¸ æ–‡ä»¶æ²¡æœ‰ front-matterï¼Œè‡ªåŠ¨æ·»åŠ ï¼"
    {
        echo "---"
        echo "title: \"$filename\""
        # echo "date: $(date '+%Y-%m-%d %H:%M:%S')"
        if [[ -n $created_date ]]; then
            echo "date: $created_date"
        else
            echo "date: $(date '+%Y-%m-%d %H:%M:%S')"
        fi
        echo "updated: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "---"
        cat "$file"
    } > "${file}.tmp" && mv "${file}.tmp" "$file"
    echo "âœ… å·²æ·»åŠ åŸºç¡€ front-matterã€‚"
    exit 0
fi

# é€ä¸€è¯¢é—®ç¼ºå¤±å±æ€§
tmpfile="${file}.tmp"
head -n "$end_line" "$file" > "$tmpfile"

for attr in "${attr_options[@]}"; do
    if has_attr "$attr"; then
        continue
    fi

    echo -n "æ˜¯å¦æ·»åŠ å±æ€§ '$attr'? (y/n): "
    read ans
    if [[ "$ans" == "y" || "$ans" == "Y" ]]; then
        if [[ "$attr" == "title" ]]; then
            value="$filename"
        elif [[ "$attr" == "date" || "$attr" == "updated" ]]; then
            value=$(date '+%Y-%m-%d %H:%M:%S')
        elif [[ "$attr" == "comments" ]]; then
            value=true
        elif [[ "$attr" == "math" ]]; then
            value=true
        # elif [[ "$attr" == "tags" ]]; then
        # elif [[ "$attr" == "categories" ]]; then
        else
            echo -n "è¯·è¾“å…¥ '$attr' çš„å€¼ï¼š"
            read value
        fi
        echo "$attr: $value" >> "$tmpfile"
    fi
done

# echo "---" >> "$tmpfile"
tail -n +"$((end_line+1))" "$file" >> "$tmpfile"
mv "$tmpfile" "$file"

echo "âœ… å±æ€§è¡¥å……å®Œæˆï¼š$file"
